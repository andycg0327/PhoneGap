<!DOCTYPE html>
<html>
<head>
<title>Myth 時尚羅盤</title>
<meta charset="utf-8" />
<meta name="format-detection" content="telephone=no" />
<meta name="msapplication-tap-highlight" content="no" />
<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
<meta name="viewport" content="user-scalable=no, initial-scale=1" />
</head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./bootstrap-3.3.4/css/bootstrap.min.css" />
<link rel="stylesheet" href="http://myth-hair.frog.tw/css/myth.css">
<script src="./js/jquery.min.js"></script>
<script src="./bootstrap-3.3.4/js/bootstrap.min.js"></script>
<script src="./js/bootstrap-validator-0.9.0.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
var app = {
	initialize: function() {
		this.bindEvents();
	},
	bindEvents: function() {
		document.addEventListener('deviceready', this.onDeviceReady, false);
	},
	onDeviceReady: function() {
		var push = PushNotification.init({
			"android": {"senderID": "100971030124", "icon": "icon", "forceShow": "true"},
			"ios": {"alert": "true", "badge": "true", "sound": "true"}, 
			"windows": {}
		});
		push.on('registration', function(data) {
			localStorage.RegistrationID = data.registrationId;
			$("input[name=RegistrationID]").val(data.registrationId);
			if(localStorage.Account && localStorage.Password) {
				$("#Account").val(localStorage.Account);
				$("#Password").val(localStorage.Password);
				LoginSubmit('Login');
			} else if(localStorage.FacebookID)
				FBLoginSubmit('Login');
		}).on('notification', function(data) {
		}).on('error', function(e) {
			console.log("push error");
		});
	}
};
app.initialize();

function LoginSubmit(Type) {
  $.post('http://myth-hair.frog.tw/login.php', $("#Form_" + Type).serialize(), function(data, status){
    if(status == "success" && data == "OK") {
      localStorage.Account = $("#Account").val();
      localStorage.Password = $("#Password").val();
      localStorage.removeItem("FacebookID");
      window.location = "./main.html";
      return true;
    } else
      $("#Alert_" + Type).html(data);
  });
	return false;
}

function FBLoginSubmit(Type) {
	facebookConnectPlugin.login(["public_profile", "email"],
		function (response) {
			if (response.status === 'connected') {
				facebookConnectPlugin.getAccessToken(function(token) {
					$("input[name=AccessToken]").val(token);
					$.post('http://myth-hair.frog.tw/loginFB.php', $("#Form_" + Type).serialize(), function(data, status){
						if(status == "success" && data == "OK") {
							localStorage.FacebookID = response.authResponse.userID;
							localStorage.removeItem("Account");
							localStorage.removeItem("Password");
							window.location = "./main.html";
							return true;
						} else
							$("#Alert_" + Type).html(data);
					});
				}, function(err) {
						alert("Could not get access token: " + err);
				});
			}
			else if (response.status === 'not_authorized')
				$("#Alert_" + Type).html('<div class="alert alert-danger fade in"><strong>使用 Facebook 登入失敗!</strong> 您尚未授權本系統。</div>');
			else
				$("#Alert_" + Type).html('<div class="alert alert-danger fade in"><strong>使用 Facebook 登入失敗!</strong> 您尚未登入Facebook。</div>');
		},
		function (error) {
			alert(error);
		}
	);
	return false;
}
</script>
<style>
.form-group {
  border-bottom: none;
  padding: 5px 0 5px 0;
}
hr {
  margin: 5px 0 5px 0;
}
</style>

<body>
<h2 class="text-center">Myth 時尚羅盤</h2>
<div id="Div_Register" class="container collapse in">
	<div class="row">
		<div class="col-xs-10 col-xs-offset-1">
			<form class="form-horizontal" id="Form_Register" data-toggle="validator" onsubmit="return LoginSubmit('Register')">
			<input type="hidden" name="Type" value="Register" />
			<input type="hidden" name="RegistrationID" value="" />
			<input type="hidden" name="AccessToken" value="" />
			<div class="form-group">
        <label class="control-label col-lg-2">我想註冊成:</label>
				<div class="col-lg-10 has-feedback">
          <i class="fa fa-users fa-fw"></i>
					<select class="form-control input-sm" name="Role">
					<option value="customer">消費者</option>
					<option value="hairdresser">設計師</option>
					</select>
				</div>
			</div>
      <hr>
			<div class="form-group">
				<div class="col-xs-12 has-feedback">
          <i class="fa fa-envelope fa-fw"></i>
					<input type="email" class="form-control input-sm" name="Account" placeholder="Email" required />
				</div>
			</div>
			<div class="form-group">
				<div class="col-xs-12 has-feedback">
          <i class="fa fa-key fa-fw"></i>
					<input type="password" class="form-control input-sm" name="Password" placeholder="密碼" pattern="^[a-zA-z0-9]{6,}" data-error="至少 6 個英數字元，區別大小寫。" required />
          <div class="help-block with-errors"></div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-xs-12 has-feedback">
          <i class="fa fa-user fa-fw"></i>
					<input type="text" class="form-control input-sm" name="Name" placeholder="稱呼" required />
				</div>
			</div>
      <div class="form-group text-center">
        <div class="col-sm-12 has-feedback">
          <button type="submit" class="btn btn-primary btn-block btn-sm" />註冊</button>
        </div>
      </div>
			<hr />
      <div class="form-group text-center">
        <div class="col-sm-12 has-feedback">
          <button type="button" class="btn btn-primary btn-block btn-sm" onClick="FBLoginSubmit('Register')"><i class="fa fa-facebook-square fa-fw"></i> 使用 Facebook 註冊</button>
        </div>
      </div>
			<p class="text-center"><button type="button" class="btn btn-link btn-sm" onclick="$('#Div_Register').fadeOut(300, function(){ $('#Div_Login').fadeIn(300); });">已經有帳號? 按此登入</button></p>
			</form>
		</div>
	</div>
</div>
<div id="Div_Login" class="container collapse">
	<div class="row">
		<div class="col-xs-10 col-xs-offset-1">
			<form class="form-horizontal" id="Form_Login" data-toggle="validator">
			<input type="hidden" name="Type" value="Login" />
			<input type="hidden" name="RegistrationID" value="" />
			<input type="hidden" name="AccessToken" value="" />
			<div class="form-group">
				<div class="col-xs-12 has-feedback">
          <i class="fa fa-envelope fa-fw"></i>
					<input type="email" class="form-control input-sm" name="Account" id="Account" placeholder="Email" required />
				</div>
			</div>
			<div class="form-group">
				<div class="col-xs-12 has-feedback">
          <i class="fa fa-key fa-fw"></i>
					<input type="password" class="form-control input-sm" name="Password" id="Password" placeholder="密碼" pattern="^[a-zA-z0-9]{6,}" data-error="至少 6 個英數字元，區別大小寫。" required />
          <div class="help-block with-errors"></div>
				</div>
			</div>
      <div class="form-group text-center">
        <div class="col-sm-12 has-feedback">
          <button type="submit" class="btn btn-primary btn-block btn-sm" onClick="LoginSubmit('Login')" />登入</button>
        </div>
      </div>
			<hr />
      <div class="form-group text-center">
        <div class="col-sm-12 has-feedback">
          <button type="button" class="btn btn-primary btn-block btn-sm" onClick="FBLoginSubmit('Login')"><i class="fa fa-facebook-square fa-fw"></i> 使用 Facebook 登入</button>
        </div>
      </div>
			<div id="Alert_Login"></div>
			<p class="text-center"><button type="button" class="btn btn-link btn-sm" onclick="$('#Div_Login').fadeOut(300, function(){ $('#Div_Register').fadeIn(300); });">註冊新帳號</button></p>
			</form>
		</div>
	</div>
</div>
<footer class="footer">
  <h6 class="text-muted">© 2016 Myth International. All rights reserved.</h6>
</footer>
</body>
</html>