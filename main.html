<!DOCTYPE html>
<html>
<head>
<title>Myth 靚化約定</title>
<meta charset="utf-8" />
<meta name="format-detection" content="telephone=no" />
<meta name="msapplication-tap-highlight" content="no" />
<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
<meta name="viewport" content="user-scalable=no, initial-scale=1" />
</head>
<link rel="stylesheet" href="./bootstrap-3.3.4/css/bootstrap.min.css" />
<script src="./js/jquery.min.js"></script>
<script src="./bootstrap-3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
var app = {
  initialize: function() {
    this.bindEvents();
  },
  bindEvents: function() {
    document.addEventListener('deviceready', this.onDeviceReady, false);
  },
  onDeviceReady: function() {
    document.addEventListener("backbutton", onBackKeyDown, false);
    window.addEventListener('message', function(e) {
      if(e.origin != 'http://myth-hair.frog.tw')
        return;
        
      var data = JSON.parse(e.data);
      switch(data.Title) {
      case "onClose":
        backbutton = true;
        setTimeout(function(){ backbutton = false; }, 2000);
        window.plugins.toast.showShortBottom('再按一次關閉程式');
        break;
      case "onSpinnerShow":
        window.plugins.spinnerDialog.show(null, null, true);
        break;
      case "onSpinnerHide":
        window.plugins.spinnerDialog.hide();
        break;
      case "onReLogin":
        window.plugins.spinnerDialog.show(null, null, true);
        if(localStorage.Account && localStorage.Password) {
          if(!LoginSubmit('Login'))
            window.location = "./index.html";
        } else if(localStorage.FacebookID) {
          if(!FBLoginSubmit('Login', ''))
            window.location = "./index.html";
        }
        window.plugins.spinnerDialog.hide();
        break;
      case "onFBConnect":
        window.plugins.spinnerDialog.show(null, null, true);
        e.source.postMessage(JSON.stringify({Title: "onFBConnect", Status: FBLoginSubmit('Connect', data.Role) ? 'OK' : 'Failed'}), e.origin);
        window.plugins.spinnerDialog.hide();
        break;
      case "onFBOpen":
        window.open('fb://' + data.URL, '_system', 'location=no');
        break;
      case "onNewPhoto":
        if(data.SourceType == "CAMERA")
          getPhoto(Camera.PictureSourceType.CAMERA, data.Role);
        else if(data.SourceType == "PHOTOLIBRARY")
          getPhoto(Camera.PictureSourceType.PHOTOLIBRARY, data.Role);
        break;
      }
    }, false);
  }
};
app.initialize();

var backbutton = false;
function onBackKeyDown() {
  if(backbutton)
    (navigator.app && navigator.app.exitApp()) || (device && device.exitApp());
  else
    document.getElementById('iframe').contentWindow.postMessage(JSON.stringify({Title: "onBackKeyDown"}), 'http://myth-hair.frog.tw');
}

function LoginSubmit(Type) {
  $.post('http://myth-hair.frog.tw/login.php', {Type: Type, Account: localStorage.Account, Password: localStorage.Password, RegistrationID: localStorage.RegistrationID}, function(data, status){
    if(status == "success")
      return data == "OK";
  });
}
function FBLoginSubmit(Type, Role) {
  facebookConnectPlugin.login(["public_profile", "email"],
    function (response) {
      if (response.status === 'connected') {
        facebookConnectPlugin.getAccessToken(function(token) {
          $.post('http://myth-hair.frog.tw/loginFB.php', {Type: Type, Role: Role, AccessToken: token, RegistrationID: localStorage.RegistrationID}, function(data, status){
            if(status == "success")
              return data == "OK";
          });
        }, function(err) {
        });
      }
      else if (response.status === 'not_authorized')
        window.plugins.toast.showShortBottom('Facebook 登入失敗: 您尚未授權本系統。');
      else
        window.plugins.toast.showShortBottom('Facebook 登入失敗: 您尚未登入Facebook。');
    },
    function (error) {}
  );
  return false;
}

function getPhoto(source, role) {
  navigator.camera.getPicture(
    function(imageURI) {
      var actualURL = imageURI;
      alert(actualURL);
      if (imageURI.startsWith("content://")) {
        window.FilePath.resolveNativePath(imageURI, function(localFileUri) {
      alert(localFileUri);
          actualURL = "file://" + localFileUri;
      alert(actualURL);
          window.resolveLocalFileSystemURL("file://" + localFileUri, function(fileEntry) {
          actualURL = fileEntry.toURL();
      alert(actualURL);
          });
        });
      }
      alert(actualURL);
      var options = new FileUploadOptions();
      options.fileKey = "file";
      options.fileName = "photo.jpg";
      options.mimeType = "image/jpeg";
      options.params = {Role: role}

      window.plugins.spinnerDialog.show(null, null, true);
      $("#Modal_Progress").modal({backdrop: "static"});
      var ft = new FileTransfer();
      ft.onprogress = function(progressEvent) {
        if (progressEvent.lengthComputable) {
          $("#Modal_Progress .progress-bar").css('width', (progressEvent.loaded / progressEvent.total * 100) + "%");
        } else {
          $("#Modal_Progress .progress-bar").css('width', "100%");
        }
      };
      ft.upload(actualURL, encodeURI("http://myth-hair.frog.tw/phonegap_photo.php"), 
        function(r) {
          document.getElementById('iframe').contentWindow.postMessage(JSON.stringify({Title: 'onNewPhoto', Role: role}), 'http://myth-hair.frog.tw');
          alert(r.response);
          window.plugins.spinnerDialog.hide();
          $("#Modal_Progress").modal('hide');
        }, 
        function(error) {
          window.plugins.toast.showShortBottom("上傳照片失敗: " + error.code);
          window.plugins.spinnerDialog.hide();
          $("#Modal_Progress").modal('hide');
        }, options
      );
    }, function(message) {
      window.plugins.toast.showShortBottom('讀取照片失敗: ' + message);
    }, { 
      quality: 80,
      sourceType: source,
      targetWidth: 1000,
      targetHeight: 1000,
      cameraDirection: Camera.Direction.FRONT
    }
  );
}
</script>
<style>
html {
  height: 100%;
}
body {
  height: 100%;
  margin: 0;
}
iframe {
  height: 100%;
  width: 100%;
  border: 0;
  vertical-align:bottom;
}
</style>

<body>
<div id="Modal_Progress" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="progress" style="margin:0">
          <div class="progress-bar progress-bar-striped active" role="progressbar" style="width:0%"></div>
        </div>
    </div>
  </div>
</div>
<iframe id="iframe" src="http://myth-hair.frog.tw/phonegap.php"></iframe>
</body>
</html>