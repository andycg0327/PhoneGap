<!DOCTYPE html>
<html>
<head>
<title>Myth 靚化約定</title>
<meta charset="utf-8" />
<meta name="format-detection" content="telephone=no" />
<meta name="msapplication-tap-highlight" content="no" />
<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
<meta name="viewport" content="user-scalable=no, initial-scale=1" />
</head>
<link rel="stylesheet" href="./bootstrap-3.3.4/css/bootstrap.min.css" />
<link rel="stylesheet" href="./css/jquery.Jcrop.min.css" type="text/css" />
<script src="./js/jquery.min.js"></script>
<script src="./bootstrap-3.3.4/js/bootstrap.min.js"></script>
<script src="./js/jquery.Jcrop.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
var app = {
  initialize: function() {
    this.bindEvents();
  },
  bindEvents: function() {
    document.addEventListener('deviceready', this.onDeviceReady, false);
  },
  onDeviceReady: function() {
    document.addEventListener("backbutton", onBackKeyDown, false);
    window.addEventListener('message', function(e) {
      if(e.origin != 'http://myth-hair.frog.tw')
        return;
        
      var data = JSON.parse(e.data);
      switch(data.Title) {
      case "onClose":
        backbutton = true;
        setTimeout(function(){ backbutton = false; }, 2000);
        window.plugins.toast.showShortBottom('再按一次關閉程式');
        break;
      case "onSpinnerShow":
        window.plugins.spinnerDialog.show(null, null, true);
        break;
      case "onSpinnerHide":
        window.plugins.spinnerDialog.hide();
        break;
      case "onReLogin":
        window.plugins.spinnerDialog.show(null, null, true);
        if(localStorage.Account && localStorage.Password) {
          LoginSubmit('Login');
        } else if(localStorage.FacebookID)
          FBLoginSubmit('Login', '');
        else
          window.location = "./index.html";
        window.plugins.spinnerDialog.hide();
        break;
      case "onFBConnect":
        window.plugins.spinnerDialog.show(null, null, true);
        if(FBLoginSubmit('Connect', data.Role))
          e.source.postMessage(e.data, e.origin);
        window.plugins.spinnerDialog.hide();
        break;
      case "onFBOpen":
        window.open('fb://' + data.URL, '_system', 'location=no');
        break;
      case "onNewPhoto":
        $("#PhotoCropRole").val(data.Role);
        $("#PhotoCropOID").val(data.OID);
        $("#Modal_NewPhoto").modal('show');
        $('#Modal_NewPhoto .modal-dialog').css('margin-top', $('#Modal_NewPhoto').height() / 2.5);
        break;
      }
    }, false);
  }
};
app.initialize();

var backbutton = false;
function onBackKeyDown() {
  if(backbutton)
    (navigator.app && navigator.app.exitApp()) || (device && device.exitApp());
  else {
    document.getElementById('iframe').contentWindow.postMessage("onBackKeyDown", 'http://myth-hair.frog.tw');
  }
}

var cropBox;
$(document).ready(function(){
  initJcrop();
  $("#Modal_PhotoCrop").on('shown.bs.modal', function () {
    $("#Div_PhotoCrop").height($("#Div_PhotoCrop").height() + $(window).height() - $("#Modal_PhotoCrop .modal-dialog").height());
    cropBox.destroy();
    initJcrop();
    $(".jcrop-holder").css('top', 'calc(50% - ' + $(".jcrop-holder").height()/2 + 'px)').css('left', 'calc(50% - ' + $(".jcrop-holder").width()/2 + 'px)');
  });
});

// Normal login
function LoginSubmit(Type) {
  $.post('http://myth-hair.frog.tw/login.php', {Type: Type, Account: localStorage.Account, Password: localStorage.Password, RegistrationID: localStorage.RegistrationID}, function(data, status){
    if(status == "success" && data != "OK")
      window.location = "./index.html";
  });
}
function FBLoginSubmit(Type, Role) {
  facebookConnectPlugin.login(["public_profile", "email"],
    function (response) {
      if (response.status === 'connected') {
        facebookConnectPlugin.getAccessToken(function(token) {
          $.post('http://myth-hair.frog.tw/loginFB.php', {Type: Type, Role: Role, AccessToken: token, RegistrationID: localStorage.RegistrationID}, function(data, status){
            if(status == "success" && data == "OK")
              return true;
          });
        }, function(err) {
        });
      }
			else if (response.status === 'not_authorized')
				alert('Facebook 登入失敗: 您尚未授權本系統。');
			else
				alert('Facebook 登入失敗: 您尚未登入Facebook。');
    },
    function (error) {
    }
  );
  if(Type == "Login")
    window.location = "./index.html";
  return false;
}

function initJcrop() {
  $('#PhotoCropbox').Jcrop({
    boxWidth: $("#Div_PhotoCrop").width(),
    boxHeight: $("#Div_PhotoCrop").height(),
    aspectRatio: 1,
    allowSelect: false,
    bgOpacity: 0.4,
    bgColor: 'black',
    onSelect: updateCoords
  },function(){
    cropBox = this;
    cropBox.setSelect([0, 0, 200, 200]);
    cropBox.setOptions({ bgFade: true });
    cropBox.ui.selection.addClass('jcrop-selection');
  });
}
function updateCoords(c) {
  $('#PhotoCropX').val(c.x);
  $('#PhotoCropY').val(c.y);
  $('#PhotoCropW').val(c.w);
  $('#PhotoCropH').val(c.h);
};
function getPhoto(source) {
  navigator.camera.getPicture(
    function(imageURI) {
      $("#PhotoCropbox").attr('src', imageURI);
      $("#Modal_PhotoCrop").modal({backdrop: "static"});
    }, function(message) {
      alert('讀取照片失敗: ' + message);
    }, { quality: 80, sourceType: source }
  );
}
function CropSubmit() {
  var options = new FileUploadOptions();
  options.fileKey = "file";
  options.fileName = $("#PhotoCropbox").attr('src').substr($("#PhotoCropbox").attr('src').lastIndexOf('/') + 1);
  alert("AA");
  options.mimeType = "image/jpeg";
  alert("AA");
  options.params = {
    Role: $('#PhotoCropRole').val(),
    CropX: $('#PhotoCropX').val(),
    CropY: $('#PhotoCropY').val(),
    CropW: $('#PhotoCropW').val(),
    CropH: $('#PhotoCropH').val()
  }
  alert("BB");

  var ft = new FileTransfer();
  alert("CC");
  ft.onprogress = function(progressEvent) {
    if (progressEvent.lengthComputable) {
      $("#progressbar").width(progressEvent.loaded / progressEvent.total).removeClass('collapse');
    } else {
      $("#progressbar").addClass('collapse');
    }
  };
  alert("DD");
  ft.upload($("#PhotoCropbox").attr('src'), encodeURI("http://myth-hair.frog.tw/phonegap_photo.php"), 
    function(r) {
      document.getElementById('iframe').contentWindow.postMessage(JSON.stringify({Title: 'onNewPhoto', Status: 'Done'}), 'http://myth-hair.frog.tw');
      $("#Modal_PhotoCrop").modal('hide');
    }, 
    function(error) {
      document.getElementById('iframe').contentWindow.postMessage(JSON.stringify({Title: 'onNewPhoto', Status: 'Failed'}), 'http://myth-hair.frog.tw');
      alert("上傳照片失敗: " + error.code);
      $("#Modal_PhotoCrop").modal('hide');
    }, options
  );
  alert("EE");
}
function removePhoto() {
  $.post('http://myth-hair.frog.tw/photo_remove.php', {Role: $("#PhotoCropRole").val()}, function(data, status){
    if(status == "success")
      document.getElementById('iframe').contentWindow.postMessage(JSON.stringify({Title: 'onNewPhoto', Status: 'Removed'}), 'http://myth-hair.frog.tw');
  });
}
</script>
<style>
html {
  height: 100%;
}
body {
  height: 100%;
  margin: 0;
}
iframe {
  height: 100%;
  width: 100%;
  border: 0;
  vertical-align:bottom;
}
</style>

<body>
<div id="Modal_NewPhoto" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="padding:0">
        <div class="list-group" style="margin:0">
          <a href="#" class="list-group-item" onclick="getPhoto(Camera.PictureSourceType.CAMERA)">拍攝新照片</a>
          <a href="#" class="list-group-item" onclick="getPhoto(Camera.PictureSourceType.PHOTOLIBRARY)">從圖庫挑選</a>
          <a href="#" class="list-group-item" onclick="removePhoto()">移除頭像</a>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="Modal_PhotoCrop" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg" style="margin:0">
    <div class="modal-content" style="background-color:#333333; color:#FFFFFF">
      <div class="modal-header">
        <h4 class="modal-title">個人頭像裁切</h4>
      </div>
      <form id="Form_Crop">
      <div class="modal-body" id="Div_PhotoCrop" style="padding:0">
        <img id="PhotoCropbox">
        <input type="hidden" id="PhotoCropRole" name="Role" />
        <input type="hidden" id="PhotoCropOID" name="OID" />
        <input type="hidden" id="PhotoCropX" name="CropX" />
        <input type="hidden" id="PhotoCropY" name="CropY" />
        <input type="hidden" id="PhotoCropW" name="CropW" />
        <input type="hidden" id="PhotoCropH" name="CropH" />
        <div class="progress collapse" style="margin:0">
          <div id="progressbar" class="progress-bar progress-bar-striped active" role="progressbar" style="width:0%"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" onClick="CropSubmit()">裁切</button>
      </div>
      </form>
    </div>
  </div>
</div>
<iframe id="iframe" src="http://myth-hair.frog.tw/phonegap.php"></iframe>
</body>
</html>